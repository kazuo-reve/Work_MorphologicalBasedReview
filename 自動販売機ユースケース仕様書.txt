
1. 代金投入ユースケース

事前条件
　初期化が異常なしで終了している
　商品送出中ではない
　稼動停止時間中ではない
　メンテナンス中ではない
　懸賞中ではない
　返金中ではない


事後条件
　次の代金投入が可能な状態になっている

処理
　アクターが投入した貨幣を受け付ける
　　濡れた紙幣や、変形した硬貨など物理的に投入不可な貨幣以外を受け付ける
　　投入不可な貨幣については即時排出する（もしくは受け付けない）
　貨幣の受付を中断する
　　装置の性能限界があるため（紙幣または硬貨を同時に複数処理できない）
　　貨幣を（１つだけ）受け付けている状態では、貨幣の正当不当判定などの一連の処理が終わるまで次の貨幣を受け付けない
　　貨幣の受付を中断している状態で、貨幣が投入された場合は、その貨幣を排出する
　　貨幣投入中断後（貨幣の正当不当判定などの一連の処理を終えて）、再び貨幣投入が可能になるまでの時間は500ミリ秒以内とする
　　投入された貨幣の正当不当判定を行う
　　定義した貨幣以外を返金する
　　　受け付ける硬貨は、日本円の10円,50円,100円,500円硬貨
　　　受け付ける紙幣は、日本円の1,000円札
　　　旧硬貨、旧紙幣については受け付けない
　　　投入された貨幣を不当と認識した場合は受け付ず、返金する（正当 不当の判定は専用のハードウェアで実施する）
　　販売ボタンが押されるまで投入可能な硬貨または紙幣の枚数の上限（下記）を超えた場合は返金する
　　　10円、50円、100円は、各20枚
　　　500円は10枚
　　　1000円札は1枚
　合計金額を計算する
　　貨幣を受け付けるたびに、残高に投入完了の貨幣の金額を加算し、合計金額を計算する
　販売可能な商品を通知する
　　販売可能な商品とは下記の通り
　　　在庫がある
　　　温度が適温になっている
　　　　温商品：52℃以上58℃以下を適温とする
　　　　冷商品：1℃以上6℃以下を適温とする
　　　残高≧当該商品の価格である
　　　投入金額に対して当該商品の釣銭が出せる
　　販売可能な商品の販売ボタンを点灯する
　　販売不可な商品の販売ボタンを点灯していない状態にする
　今まで受け付けた投入金額の合計を知らせる
　　紙幣または硬貨が受け付けられていない場合は、金額表示機に「0」を表示する
　　紙幣または硬貨が受け付けられている場合は、金額表示機に合計額を表示する
　後処理を実施する
　　貨幣種別毎に格納可能な枚数の条件チェックをする
　　硬貨ごとの合計枚数の条件チェックをする
　　次の金額投入を可能にする

処理（サブフロー）
　残金返金用タイムアウト
　　代金を投入後または商品を販売後に10分経過しても代金の追加投入がない場合、残金を返金する（一定時間以上商品販売をしていない場合に、アクターに代金投入にて預かった貨幣を返却するため）


2. 商品選択ユースケース

事前条件
　初期化が異常なしで終了している
　商品送出中ではない
　稼動停止時間中ではない
　メンテナンス中ではない
　懸賞中ではない
　返金中ではない
　1つ以上の販売ボタンが点灯している

事後条件
　次の代金投入が可能な状態になっている
　当該商品の在庫が１つ減っている
　金額表示が合計金額から当該商品の金額を引いた値になっている。

処理（メインフロー）
　販売ボタンが押下された商品を当該商品として受け付ける
　　懸賞中でない場合
　　販売ボタンが押下されたら販売ボタンを点滅する
　　「貨幣の受付を中断する」へ
　懸賞中で当たってから20秒以内の場合
　　販売ボタンが押下されたら懸賞あたりランプおよび懸賞対象の商品の販売ボタンを消灯する
　　金額表示機に残高を表示する
　懸賞中で当たってから20秒過ぎた場合
　　販売ボタンを消灯する
　　「あたり」ランプを消灯する
　　代金投入ユースケースへ
　貨幣の受付を中断する
　　装置の処理限界があるため（商品送出と貨幣受付を同時に処理できない）
　　貨幣の受付を中断している状態で、貨幣が投入された場合は、その貨幣を排出する
　　商品の送出を完了した時点で貨幣の受付を再開する
　押下した販売ボタンを点滅する
　　当該商品を送出中であることを押下された販売ボタンを点滅することでアクターに伝える
　　押下したボタンを離すタイミングで点滅が始まり商品の送出を完了した時点で点滅が止まる
　当該商品の販売額を残高から減算し、結果を表示する
　　商品購入前の残高から当該商品の金額を減算する
　　計算結果を金額表示機に表示する
　商品購入時の返金処理
　　残高が購入可能な商品の金額を下回った場合は、返金処理を行う
　　残高で、まだ購入可能な商品がある場合は、連続購入を可能とするため返金処理は行わない
　商品を送出する
　　押下された販売ボタンに関連付けられたラックから1つ、商品を送出する
　　　販売ボタンが複数のラックに関連付けられている場合、前回と同じラックからは商品を送出しない（初回は管理番号の一番若いラックから送出する。当該ラックが空の場合は次の管理番号のラックから商品を送出する。）
　　　当該商品の管理在庫数を1本減らす
　　商品送出後の処理
　　　販売ボタンを消灯する
　　　懸賞ユースケースへ
　　商品が詰まった場合の振る舞い
　　　商品取り出し口センサが、商品が1分間詰まっていることを検知した場合、返金処理を行い、販売ボタンを消灯し、全ての売切表示ランプを点灯し、販売を停止する


3. 返金ユースケース

事前条件
　初期化が異常なしで終了している
　商品送出中ではない
　稼動停止時間中ではない
　メンテナンス中ではない
　懸賞中ではない

事後条件
　次の代金投入が可能な状態になっている
　残高がゼロ円になること
　釣銭払出動作中表示ランプが消灯している
　販売ボタンが消灯している

処理（メインフロー）
　返金処理の開始契機
　　アクターが返金ボタンを押下した場合
　　タイムアウト条件は、「代金を投入後または商品を販売後に残高が残っている状態で 10 分経過しても代金の追加投入がなく、商品選択がない場合」
　　アクターが商品購入後、残高が販売可能な商品の金額を下回った場合
　返金前処理
　　代金投入の受付を中断する
　　販売ボタンを消灯する
　　釣銭払出動作中表示ランプを点滅する
　　　釣銭払出動作中表示ランプの点滅は、釣銭払出完了まで続く
　返金処理
　　紙幣、硬貨の優先順位で残高を減算するとともに返金する
　　　1,000円札が投入されている状態であればそれを返金する
　　　排出硬貨の枚数が最少になるように、金額の大きい硬貨順に一枚ずつ返却口から排出する
　　　排出した貨幣の額を逐次残高から減算し、残高を更新表示する
　　　残高が 0 になるまで硬貨排出・残高更新表示を繰り返す
　　釣銭払出動作中表示ランプを消灯する

4. 懸賞ユースケース
　
事前条件
　初期化が異常なしで終了している
　商品送出中ではない
　稼動停止時間中ではない
　メンテナンス中ではない
　返金中ではない
　懸賞付きの商品が購入された
　懸賞あたりによって販売ボタンを押下した状態ではない（2度当たりを無くすため）
　懸賞対象の商品の在庫が少なくとも一本ある

事後条件
　次の代金投入が可能な状態になっている

処理（メインフロー）
　懸賞ルーレットの処理
　　懸賞対象の商品の販売ボタンが押下されたときにルーレットを開始する
　　　ルーレットを開始する
　　ルーレットを5秒間回す
　　　ルーレットが回っている間、音を流す
　　ルーレットを止めて、懸賞結果をアクターに示す
　　　あたりの場合、「あたり」のランプを点灯する
　　　はずれの場合、 「残念！はずれ」のランプを点灯する
　懸賞あたりの処理
　　懸賞付き商品の販売ボタンを点灯する
　　5秒後「あたり」ランプを消灯する　
　　商品選択ユースケースへ
　懸賞はずれの処理
　　5秒後「残念！はずれ」ランプを消灯する
　　代金投入ユースケースへ


5. 故障ユースケース

事前条件
　稼動停止時間中ではない
　メンテナンス中ではない
　返金中ではない

事後条件
　自動販売機を停止状態にする

処理（メインフロー）
　故障の定義
　　故障状態とは、以下の現象を自動販売機側で検出している状態をいう。
　　　商品が送出途中で 1 分間以上詰まった状態である
　　　ラック内商品温度が設定温度範囲内に 1 時間以上経過しても達しない
　　　その他のハード故障
　故障を検出したときの処理
　　すべての販売ボタン内の「売切れ表示ランプ」を点灯する
　　自動販売機は代金投入の受付を禁止する
　　商品送出前である場合は可能な限り商品を送出する
　　返金ユースケースを実行する
　　自動販売機の売り切れ表示ランプ点灯以外の機能を停止する

Copyright© NPO 法人 ASTER
　
